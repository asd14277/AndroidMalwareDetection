# coding=UTF-8
'''
@Date: 2019-05-14 16:47:39
@Author: p4ssw0rd
@Blog: http:www.tjuscswyz.cn
'''

from androguard.core.bytecodes import apk, dvm
from androguard.core.analysis import analysis
import re
import codecs

def get_permissions(path, ):
    str = "Permission:"
    app = apk.APK(path)
    permission = app.get_permissions()
    return permission

def get_apis(path, ):
  app = apk.APK(path)
  app_dex = dvm.DalvikVMFormat(app.get_dex())
  app_x = analysis.Analysis(app_dex)
  methods = set()
  cs = [cc.get_name() for cc in app_dex.get_classes()]

  for method in app_dex.get_methods():
    g = app_x.get_method(method)
    if method.get_code() == None:
      continue

    for i in g.get_basic_blocks().get():
      for ins in i.get_instructions():
        output = ins.get_output()
        match = re.search(r'(L[^;]*;)->[^\(]*\([^\)]*\).*', output)
        if match and match.group(1) not in cs:
          methods.add(match.group())

  methods = list(methods)
  methods.sort()
  return methods
def RF_get_feature(path):
    """
    获取apk特征集
    :param path:
    :return:
    """
    feature_list = get_permissions(path)+get_apis(path)
    feature_list = list(set(feature_list))
    return list(feature_list)
def DBN_get_feature(path):
    """
      :param path: DBN
    """
    feature_list = get_permissions(path)
    feature_list = list(set(feature_list))
    return list(feature_list)

  
def get_feature_dict(FEATURE_PATH):
    """
    获取所有已知的特征集合，并返回dict
    :return:
    """
    with codecs.open(FEATURE_PATH, "r",encoding='utf-8') as f:
        feature_list = f.read().split("\n")
    feature_dict = {}
    for v in feature_list:
        v=v.strip()
        feature_dict[v] = 0
    return feature_dict