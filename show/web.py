# coding=utf-8
__auther__='p4ssw0rd'

from flask import Flask, render_template, request, redirect, url_for, make_response,jsonify

from back.handler import *
from werkzeug.utils import secure_filename
import requests
import urllib
import os
from hashlib import md5
app = Flask(__name__,template_folder='template')


def result_param( isapk, learning_method,malware=None):
    if isapk is True:
        isapk=1
        if learning_method=='RF':
            learning_method="随机森林"
        elif learning_method=='DBN':
            learning_method="深度置信网络"
        if malware==1:
            malware="恶意"
        elif malware==0:
            malware="非恶意"
    else:
        isapk=0
    return render_template('result.html', isapk=isapk,learning_method=learning_method, malware=malware)
@app.route('/', methods=['GET'])
def index():
    return render_template('index.html')

@app.route('/url', methods=['GET', 'POST'])
def url():
    if request.method == 'GET':
        return render_template('url.html')
    elif request.method == 'POST':
        r =request.form['url']
        # learning_method=request.form['method']
        name = os.urandom(5)
        name = md5(name).hexdigest()
        LocalPath=os.path.join('./data',name)
        urllib.request.urlretrieve(r,LocalPath)
        learning_method = request.form['option']
        isapk,malware = ans(learning_method,LocalPath)
        print(isapk,malware)
        return result_param(isapk,learning_method,malware)
        

@app.route('/result', methods=['POST'])
def result():
    f =request.files['file']
    learning_method = request.form['option']
    LocalPath=os.path.join('./data',secure_filename(f.filename))
    f.save(LocalPath)
    isapk,malware = ans(learning_method,LocalPath)
    return result_param(isapk,learning_method,malware)
    


if __name__=='__main__':
    app.run(host='0.0.0.0', port=23946, debug=True)